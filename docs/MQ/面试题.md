<!-- TOC -->
- [你们为什么使用mq？具体的使用场景是什么？](#你们为什么使用mq？具体的使用场景是什么？)
- [参考资料](#参考资料)
<!-- /TOC -->

## 你们为什么使用mq？具体的使用场景是什么？
mq的作用很简单，削峰填谷。以电商交易下单的场景来说，正向交易的过程可能涉及到创建订单、扣减库存、扣减活动预算、扣减积分等等。每个接口的耗时如果是100ms，那么理论上整个下单的链路就需要耗费400ms，这个时间显然是太长了。
![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5ad24e45436d48eca02bd9af92631bf4~tplv-k3u1fbpfcp-zoom-1.image)
如果这些操作全部同步处理的话，首先调用链路太长影响接口性能，其次分布式事务的问题很难处理，这时候像扣减预算和积分这种对实时一致性要求没有那么高的请求，完全就可以通过mq异步的方式去处理了。同时，考虑到异步带来的不一致的问题，我们可以通过job去重试保证接口调用成功，而且一般公司都会有核对的平台，比如下单成功但是未扣减积分的这种问题可以通过核对作为兜底的处理方案。

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0508a3368c224cebbd9811ab77705a22~tplv-k3u1fbpfcp-zoom-1.image)

使用mq之后我们的链路变简单了，同时异步发送消息我们的整个系统的抗压能力也上升了。

## 那你们使用什么mq？基于什么做的选型？
我们主要调研了几个主流的mq，kafka、rabbitmq、rocketmq，选型我们主要基于以下几个点去考虑：

由于我们系统的qps压力比较大，所以性能是首要考虑的要素。
开发语言，由于我们的开发语言是java，主要是为了方便二次开发。
对于高并发的业务场景是必须的，所以需要支持分布式架构的设计。
功能全面，由于不同的业务场景，可能会用到顺序消息、事务消息等。

基于以上几个考虑，我们最终选择了RocketMQ。

||Kafka|RocketMQ|RabbitMQ|
|-|-|-|-|
|单机吞吐量|10w级|10w级|w级|
|开发语言|Scala|Java|Erlang|
|高可用|分布式架构|分布式架构|主从架构|
|性能|ms级|ms级|us级|
|功能|只支持主要的MQ功能|顺序消息、事务消息等功能完善|并发强、性能好、延时低|

## 你上面提到异步发送，那消息可靠性怎么保证？
消息丢失可能发生在生产者发送消息、MQ本身丢失消息、消费者丢失消息3个方面。

### 生产者丢失
生产者丢失消息的可能点在于程序发送失败抛异常了没有重试处理，或者发送的过程成功但是过程中网络闪断MQ没收到，消息就丢失了。

由于同步发送的一般不会出现这样使用方式，所以我们就不考虑同步发送的问题，我们基于异步发送的场景来说。

异步发送分为两个方式：异步有回调和异步无回调，无回调的方式，生产者发送完后不管结果可能就会造成消息丢失，而通过异步发送+回调通知+本地消息表的形式我们就可以做出一个解决方案。以下单的场景举例。

1. 下单后先保存本地数据和MQ消息表，这时候消息的状态是发送中，如果本地事务失败，那么下单失败，事务回滚。
2. 下单成功，直接返回客户端成功，异步发送MQ消息
3. MQ回调通知消息发送结果，对应更新数据库MQ发送状态
4. JOB轮询超过一定时间（时间根据业务配置）还未发送成功的消息去重试
5. 在监控平台配置或者JOB程序处理超过一定次数一直发送不成功的消息，告警，人工介入。




## 参考资料
- [《我想进大厂》之MQ夺命连环11问](https://juejin.im/post/6877741789680238600)